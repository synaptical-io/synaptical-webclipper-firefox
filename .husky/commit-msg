#!/usr/bin/env bash

# Strict mode
set -euo pipefail

# --- Load nvm ---------------------------------------------------------
# nvm normally works by modifying your shell profile to source nvm.sh.
# However, Husky hooks run in a non-interactive, non-login shell, so those
# profile scripts are not loaded. As a result, nvm (and thus node/npm/npx)
# are unavailable unless we source nvm.sh manually here.
# This issue often shows up in Git GUI clients, where hooks that work in
# a terminal fail because nvm was never initialized.
export NVM_DIR="$HOME/.nvm"

# Verify nvm is installed and load it
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
else
  echo "commit-msg: nvm.sh not found at $NVM_DIR/nvm.sh" >&2
  exit 1
fi

# --- Select Node version ----------------------------------------------
# If the repo has .nvmrc, use that version; otherwise use 'default'
if [ -f ".nvmrc" ]; then
  nvm use --silent >/dev/null
else
  nvm use --silent default >/dev/null 2>&1 || nvm use --silent >/dev/null || {
    echo "pre-commit: nvm use failed (no matching Node version)" >&2
    exit 1
  }
fi

# --- Run your commit-msg commands -------------------------------------
./node_modules/.bin/commitlint --edit "$1"
# npm run commitlint -- --edit "$1"
